# Ultra-minimal Dockerfile using Alpine and static linking
# This demonstrates SMALL CONTAINERS and FAST CONTEXT SWITCHING

# Stage 1: Builder with musl for static linking
FROM rust:1.82-alpine AS builder

# Install build dependencies
RUN apk add --no-cache \
    musl-dev \
    openssl-dev \
    openssl-libs-static \
    pkgconfig

# Detect architecture and add appropriate musl target
RUN ARCH=$(uname -m) && \
    if [ "$ARCH" = "x86_64" ]; then \
        rustup target add x86_64-unknown-linux-musl; \
        echo "x86_64-unknown-linux-musl" > /tmp/target; \
    elif [ "$ARCH" = "aarch64" ]; then \
        rustup target add aarch64-unknown-linux-musl; \
        echo "aarch64-unknown-linux-musl" > /tmp/target; \
    else \
        echo "Unsupported architecture: $ARCH" && exit 1; \
    fi

# Set working directory
WORKDIR /build

# Copy runtime source
COPY runtime/Cargo.toml runtime/Cargo.lock* ./
COPY runtime/src ./src

# Build statically linked binary for the detected architecture
ENV RUSTFLAGS="-C target-feature=+crt-static"
RUN TARGET=$(cat /tmp/target) && \
    cargo build --release --target $TARGET

# Stage 2: Minimal runtime (FROM scratch would be even smaller)
FROM alpine:latest

# Install only CA certificates (minimal runtime dependency)
RUN apk add --no-cache ca-certificates && \
    rm -rf /var/cache/apk/*

# Create runtime directories
RUN mkdir -p /var/runtime /opt/faas-runtime/bin /var/task

# Copy the statically linked binary from builder stage
COPY --from=builder /build/target/*/release/faas-runtime /opt/faas-runtime/bin/runtime

# Create bootstrap script
RUN echo '#!/bin/sh' > /var/runtime/bootstrap && \
    echo 'exec /opt/faas-runtime/bin/runtime' >> /var/runtime/bootstrap && \
    chmod +x /var/runtime/bootstrap

# Set working directory
WORKDIR /var/task

# Set the entrypoint
ENTRYPOINT ["/var/runtime/bootstrap"]
